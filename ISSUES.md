# THIS IS A GUIDE TO DOCUMENT THE KNOWN PROBLEMS IN THE APP.

## I WILL DOCUMENT KNOW PROBLEMS BELOW THAT I FIND AND NEED FIXING. ALWAYS REFER TO IT MARK COMPLETE ONCE A FIX IS APPLIED AND MARK [X] FOR COMPLETED

## ISSUES:
- [X] BULK CIRCUIT ADDITION DOES NOT WORK PROPERLY. WHEN CIRCUITS ARE ADDED IN BULK THEY DON'T SHOW IN THE PANEL SCHEDULE THEY WERE ADDED. SOMETIMES IT SHOWS THEY CIRCUIT # IN () CORRECT AND THE LOAD BUT THE CIRCUITS DON'T SHOW. **FIXED 2025-12-02** - Added optimistic updates to useCircuits hook + database migration for unique constraint. See CIRCUIT_DISPLAY_FIX.md
- [X] WHEN ADDING A CIRCUIT MANUALLY THE SAME HAPPENS. WHEN YOU ADD THE FIRST ONE IT WORKS BUT THEN THE SECOND ONE DOES NOT WORK AND IT SHOWS THE TOTAL LOAD TOO. **FIXED 2025-12-02** - Same fix as above. Circuits now appear instantly with optimistic updates.
- [X] CIRCUITS WITH 2 OR 3 PONES SHOULD BE ABLE TO OCCUPY 2 OR 3 POLES TOGETHER IN THE PANEL SCHEDULE. THERE IS NO POSIBILITY OF REMOVING CIRCUITS INDIVIDUALLY, ONLY EDITING THE DESCRIPTION IN THE PANEL SCHEDULE. I NEED TO BE ABLE TO DELETE THEM COMPLETELY AND MODIFY LOAD IF NECESSARY(NOT ONLY THE NAME) **FIXED 2025-12-02** - Multi-pole circuits now show visual badges (2P/3P) and occupy multiple slots with continuation indicators. Added delete button (trash icon on hover) for all circuits. Added load_watts editing capability. See PANEL_SCHEDULE_ENHANCEMENTS.md
- [X] I NOTICE THE FOLLOWING: WHEN ADDING ONE PANEL TO THE MDP (SAY 'LP') I CAN'T ADD ANOTHER PANEL TO THAT LP DOWNSTREAM IT GETS ADDED IN THE LIST BUT NOT IN THE RISER DIAGRAM. **FIXED 2025-12-03** - Implemented recursive rendering for cascading panel hierarchies. One-line diagram now shows unlimited depth: MDP → Panel → Subpanel → etc., and transformers at any level with their downstream panels. See CASCADING_HIERARCHY_FIX.md 
- [X] PROGRAM IS ALLOWING TO ADD PANELS OR ELEMENTS THAT ARE NOT COMPATIBLE. FOR EXAMPLE IT ALLOWS YOU TO ADD A 208V 3PH PANEL DIRECTLY TO A 480V 3PH PANEL. THIS SHOUDL NOT BE ALLOWED OVERALL SYSTEMS SHOULD BE COMPATIBLE IN ALL THE POSSIBLE COMBINATIONS. YOU CAN'T CONNECT A 3PHASE PANEL TO A SINGLE PHASE PANEL ETC. EVALUATE WITH THE ENGINEER AGENT ALL THE POSSIBLE COMBINATIONS. **FIXED 2025-12-02** - Implemented comprehensive voltage/phase compatibility validation. Blocks dangerous connections (e.g., 480V→208V without transformer), warns about unusual configurations (e.g., high-leg delta), allows valid connections (same voltage/phase, line-to-neutral derivatives). See VOLTAGE_PHASE_VALIDATION.md 
- [X] ONCE THE FEEDER IS CREATED BETWEEN 2 PANELS IT SHOULD ALSO UPDATE IF THE LOAD IS CHANGED IN THE PANEL LATER ON AND IT IS NOT DOING IT. OR AT LEATS A NOTIFICATION SAYING THAT THE LOAD WAS UPDATED. **FIXED 2025-12-04** - Added `feederLoadSync.ts` service to detect stale feeders. FeederManager now shows a warning banner when panel loads change with one-click recalculation. Each feeder card shows an "Outdated" badge with load difference percentage.
- [X] THERE SHOULD BE NO WAY OF CREATING A FEEDER FOR PANELS THAT ARE NOT CONNECTED. FOR EXAMPLE IF I CREATE PANEL LP(480V) FED FROM MDP(480V) AND THEN CREATE A PP(208V) FED THROUGH A XFMR TO MDP. THE PROGRAM SHOULD NOT BE ABLE TO CREATE A FEEDER FROM LP TO PP PANELS. CONSULT THE ENGINEER AGEN FOR THE BEST RESULT. **FIXED 2025-12-04** - Added `panelConnectivityValidation.ts` service. Feeder form now validates panel connectivity before allowing save. Panels on different voltage segments (separated by transformers) cannot have direct feeders. Shows clear error messages explaining why connection is invalid.
- [X] PANEL MDP SHOULD BE ABLE TO BE ELIMINATED ONCE CREATED. **FIXED 2025-12-02** - MDP can now be deleted with strong warning message (no longer blocked). User must confirm understanding that deleting the only MDP removes service entrance. See PANEL_SCHEDULE_ENHANCEMENTS.md
- [X] WHEN CREATING A TRANSFORMER OR ADDING A PANEL CONNECTED TO ANOTHER PANEL IT CREATES BUT IT DOES NOT SHOW ON THE ONE LINE DIAGRAM. IT SEEMS THE LIMIT IS ONE PANEL AFTER THE BUS FROM THE MDP. **FIXED 2025-12-03** - Same fix as Issue #4 above. Recursive rendering now supports transformers at any panel level (not just MDP), with proper cascading to downstream panels. See CASCADING_HIERARCHY_FIX.md
- [X] WHEN CONNECTING ONE PANEL TO ANOTHER TROUGH THE ONE-LINE. THE LOAD FROM THE PANEL DOWNSTREAM SHOULD BE TRANSLATED UPSTREAM TO THE FEEDING PANEL. EVALUATE WHICH LOAD SHOULD BE TRANSLATED TO THE FEEDING PANEL(DEMAND OR CONNECTED) BASED ON CODE REQUIREMENTS. THE PANEL SHOULD CONNECT TO THE AVAILABLE CIRCUITS ON THE PANEL. **FIXED 2025-12-04** - Added `upstreamLoadAggregation.ts` service implementing NEC 220.40. **CORRECTED 2025-12-04** - Demand factors now applied to SYSTEM-WIDE totals (not per-panel). Motors: only ONE largest at 125%. Receptacles: first 10kVA system-wide at 100%. Lighting: uses occupancyType (dwelling=35% factor, commercial=100%). Uses existing Table 220.42 data.
- [X] GROUNDING AND BONDING CHECKBOXES DON'T PERSIST / DON'T WORK. **FIXED 2025-12-04** - Created `useGrounding` hook for database persistence to the `grounding_details` table. Checkboxes now save with optimistic updates and real-time sync. Added NEC 250 improvements: auto GEC sizing recommendations, EGC sizing tables (250.66, 250.122), compliance status checking, tabbed UI for electrodes/bonding/sizing.
- [X] WHEN CREATING A RESIDENTIAL SYSTEM 120/240v. iT IS PERMITTED TO ADD CIRCUITS 3P CAUSING ERRORS. IT IS ALSO PERMITTED ADDING MDP THAT IS DIFFERENT FROM A RESIDENTIOAL SYSTEM LIKE 208 3PH **FIXED 2025-12-05** - Added validation to block 3-pole circuits in single-phase panels (residential). Added validation to enforce 120/240V single-phase for residential project MDPs. 3P option now disabled in pole dropdowns when panel is single-phase. Clear error messages explain the constraint.
- [X] MAIN PANEL CAN'T BE EDITED OR CHANGED AFTER CREATED. **FIXED 2025-12-05** - Added inline edit form for all panels including MDP in the Panels List. Can now edit: name, bus rating, main breaker, location, voltage, and phase (with residential project constraints). Warns about downstream panel impact when changing voltage/phase.
- [X] WHEN I DELETE A PROJECT IN THE DASHBOARD I NEED TO REFRESH THE PAGE TO MAKE IT DISSAPEAR. **FIXED 2025-12-05** - Added optimistic update to `deleteProject()` in useProjects hook. Projects now disappear immediately from the dashboard without refresh. Includes rollback on error.
- [X] WHEN I CREATE A PANEL SCHEDULE FROM THE DWELLING CALCULATOR THERE IS NO WAY TO DELET IT. LIKE I CAN FOR COMMERCIAL. ALSO, IF I DECIDE TO GENERATE ANOTHER ONE IT SHOULD OVERRIDE THE ONE ALREADY CREATED. **FIXED 2025-12-05** - Added `deleteCircuitsByPanel()` to useCircuits hook. DwellingLoadCalculator now shows: (1) Panel circuit count, (2) "Clear" button to delete all circuits, (3) "Regenerate Schedule" button text when circuits exist, (4) Confirmation dialog explaining override behavior.
- [X] When you update the Panel Main Breaker, it does not update in the riser diagram. I need to get that fixed. **FIXED 2025-12-07** - Added optimistic update to `updatePanel()` in usePanels hook. Panel changes now reflect immediately in the riser diagram without waiting for real-time subscription.
- [X] WHEN CREATING FEEDER. THE FEEDER IS BASED ONLY ON THE EXISTING LOAD OF THE PANEL. IT SHOULD HAVE THE OPTION OF BASING IT ON THE LOAD OF THE PANEL OR IN THE MAX CAPACITY. **FIXED 2025-12-07** - Added "Sizing Basis" toggle in FeederManager with two options: "Calculated Load" (existing behavior) and "Panel Max Capacity" (uses main breaker or bus rating).
- [X] THE FEEDER CALCULATOR ALSO HAVE ISSUES WITH THE EGC CALCULATION. IT SHOUDL BE BASED OFF OF THE OCPD OF THE PANEL PROTECTING THE DOWNSTREAM PANEL. EG. FEEDER FROM A ---> B SHOULD BE CALCULATED BASED ON NEC TABLE 250.122 FOR 'B' OCPD ON PANEL A. **FIXED 2025-12-07** - EGC now correctly sized based on destination panel's OCPD (main_breaker_amps or feeder_breaker_amps) per NEC Table 250.122, not the calculated design current.
- [X] The one-line diagram subpage under Circuit Design needs to be only the one-line diagram. But when you click Circuit Design, it should be the one-line plus the panel, the Add Circuit, the rest of the thingS (CIRCUIT DESIGN & ONE LINE). **FIXED 2025-12-26** - Added `diagramOnly` prop to OneLineDiagram component. "One-Line Diagram" menu shows only the diagram enlarged, "Circuit Design" shows full layout with forms.
- [X] I want to remove the Add Circuit utility from the Circuit Design page and move it to the Panel ScheduleS. I want to be able to add circuits and load classifications and anything you have in that utility directly in the panel schedules. When you add that circuit, that circuit must count in the circuit design riser diagram. So everything should be connected. But I don't want that utility being independent from the panel schedules. The only thing you have right now is that you can edit an already created circuit, but you cannot create one directly in the final schedule. So I want to add that utility. So this add circuit under circuit design should be moved away from it. **FIXED 2025-12-26** - Added inline "+ Add Circuit" row in panel schedule table with full form fields. Removed "Add Circuit" section from Circuit Design page. Includes circuit slot validation for multi-pole circuits, manual circuit number assignment, and real-time conflict detection with visual feedback.
- [X] There's another issue on the circuit design. You have on the left side of the page all the cards where you have "Add Panel," "Bus," "Add Circuit," "Add Transformer," all on the left. But on the right side, you only have the one-line diagram that ends right there. So you have to scroll down a lot, and then you have a lot of white space on the right side of that. I want to improve that. I know that by removing the add circuit, some space is going to be recovered, but I want to have a better design. **FIXED 2025-12-26** - Changed grid layout from 3-column to 2-column (320px sidebar + 1fr diagram). Made diagram sticky with `lg:sticky lg:top-4` and taller `lg:h-[calc(100vh-12rem)]`. Left sidebar now scrolls independently with `lg:overflow-y-auto`. Eliminates white space and reduces scrolling.
- [X] Under Site Visit Login, you don't have a way to change from Completed to Scheduled, In Progress, or Cancel. So once you create it, you don't have any way to change the status of it. Also, if you have one that is Scheduled, it should show on Calendar. It's not connected at all. **FIXED 2025-12-26** - Replaced status badge with dropdown selector in visit cards. Added calendar integration: when status changes to "Scheduled", automatically creates calendar event with `related_site_visit_id` link. When status changes away from "Scheduled", removes calendar event. Works for both new and existing site visits. 
- [X] When starting from scratch in the project and I try to choose a project template, there are three tabs on the top: Residential, Commercial, and Industrial. When I click Start from scratch, the Select a template button is not available to click. So the only way to click is to start blank. I don't understand what the start blank button is if you already have a start from scratch tab to select. **FIXED 2026-01-01** - Removed redundant "Start Blank" button from footer. Main button now changes text: "Use This Template" when template selected, or "Start Blank Project" when "Start from Scratch" is selected. Button is always enabled. Simplified UX with one clear action button.
- [X] I noticed that when you create a project, either residential, commercial, or industrial, it presents to the residential. I noticed because when I tried to do the circuit design, it's not available because the dwelling calculator is present instead of the circuit design as if it was an industrial commercial. **FIXED 2026-01-01** - Fixed project type selection. When clicking "Start from Scratch" on Commercial or Industrial tabs, project now correctly uses that type (not default to RESIDENTIAL). Default service parameters now match project type: Residential=240V 1φ, Commercial=208V 3φ, Industrial=480V 3φ. Occupancy type set appropriately.
- [X] In the circuit design section, When I try to create a new feeder for feeder sizing, it does not allow me to select A transformer as a source. It allows me to select the transformer as a destination but it doesn't allow me to select it as a source. Also, when the transformer is the destination, make sure to have the capability to do size of feeder based on the transformer being fed max capacity because it allows me right now to size max capacity on the destination panel but not in the destination transformer. Make sure also the labels show up when I create the feeder too Because I'm having problems showing some features from the transformer to panels or from panels to transformers. **FIXED 2026-01-01** - Added transformer source support: (1) Database migration added `source_transformer_id` column with XOR constraints, (2) FeederManager UI updated with source type toggle (panel vs transformer), (3) Transformer max capacity sizing implemented (uses kVA rating), (4) Labels fixed to display transformer sources correctly (transformer → panel, transformer → transformer), (5) **ADDITIONAL FIX**: Destination filtering now only shows DOWNSTREAM panels (siblings excluded - e.g., H1 and H2 no longer show when H3 is selected as source), (6) **ADDITIONAL FIX**: Feeder name now auto-generates as "Source → Destination" when source and destination are selected. See `/types.ts`, `/components/FeederManager.tsx`, and `/services/validation/panelConnectivityValidation.ts`.
- [X] One-line diagram visibility issue - when the diagram gets too wide it cuts off on the side with no scrolling. **FIXED 2026-01-01** - Changed container `overflow-hidden` to `overflow-auto` in both diagram views (full view and circuit design page). Diagram now scrolls horizontally and vertically when content exceeds viewport. See `/components/OneLineDiagram.tsx` lines 1545 and 2202.
- [X] One-line diagram PNG/PDF export cut off - exported diagrams have content clipped on right side, text appears shifted or too big. **FIXED 2026-01-01** - Implemented dynamic viewBox width calculation based on actual content positions (tree layout + manual offsets + padding for feeder labels). ViewBox width now expands automatically to fit wide diagrams instead of fixed 800px. Fixes both PNG and PDF exports since they read viewBox dimensions. See `/components/OneLineDiagram.tsx` lines 304-330 and SVG viewBox updates.
- [X] Grounding electrodes not showing in permit packet PDF even when checked in app - shows "No grounding electrodes specified" incorrectly. **FIXED 2026-01-01** - Fixed type mismatch between database schema (snake_case fields: `gec_size`, `electrodes`) and PDF component expecting camelCase. Changed PDF to use correct database Row type `Database['public']['Tables']['grounding_details']['Row']` instead of custom `GroundingDetail` interface. Removed non-existent EGC section. Fixed PermitPacketData interface to use correct database type. **ADDITIONAL FIX 1**: Checkboxes now render using ASCII characters `[X]` (checked, green, bold) and `[ ]` (unchecked, gray) with Courier font instead of Unicode symbols that weren't rendering in PDF. **ADDITIONAL FIX 2**: Fixed electrode name matching - changed from short codes ('rod', 'pipe') to full database names ('Rod and Pipe Electrodes', 'Metal Underground Water Pipe', etc.). Now correctly shows checkmarks for selected electrodes. See `/services/pdfExport/GroundingPlanDocuments.tsx` and `/services/pdfExport/permitPacketGenerator.tsx`.
- [X] Permit Packet tab navigation bug - clicking away from permit packet page changes URL but content doesn't update. **FIXED 2026-01-01** - Wrapped entire ProjectView return in `<div key={location.pathname}>` to force full component remount when pathname changes. This ensures Layout and all child components properly unmount/remount on route changes, clearing any stuck state. Previous fix with Routes key wasn't aggressive enough. See `/App.tsx` lines 74-196.
- [X] Jurisdiction requirements not appearing in permit packet PDF even when jurisdiction selected and saved. **FIXED 2026-01-02** - Root cause was `frontendProjectToDbUpdate()` in `/lib/typeAdapters.ts` stripping out `jurisdiction_id` field during project updates. Also fixed missing optimistic updates in `updateProject()` in `/hooks/useProjects.ts` and infinite loop in `JurisdictionSearchWizard.tsx` useEffect dependencies. Changes: (1) Added `jurisdiction_id` to both `frontendProjectToDbUpdate()` and `dbProjectToFrontend()`, (2) Added optimistic state updates to `updateProject()` for instant UI refresh without waiting for real-time subscription, (3) Fixed useEffect infinite loops by removing function dependencies (`searchJurisdictions`, `getJurisdictionById`) from dependency arrays. Jurisdiction checklist page now appears correctly in permit packet when jurisdiction is saved. **MIGRATION REQUIRED**: `/supabase/migrations/20251231_seed_jurisdictions_only.sql` to seed 6 jurisdictions (FL + TX). See `/docs/PERMIT_PACKET_MARKET_ANALYSIS.md` for complete market analysis.

##### NOTE: NOTIFY THE USER IF A MODIFICATION OF THE SUPABASE IS NEEDED WHEN FIXING ANY PROBLEM OR DOING ANY MODIFICATION. THE USER IS USING THE *.SQL FILES FROM THE REPO LOCATION. ALWAYS CONSULT THE AGENTS TO MAP THE PROBLEM AND PERFORM THE BEST POSSIBLE SOLUTION BEFORE APPLYING THE FIX.